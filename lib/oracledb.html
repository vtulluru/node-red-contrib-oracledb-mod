<!-- Oracle-SERVER - CONFIG ----------------------------------------------------->

<script type="text/x-red" data-template-name="oracle-server">
    <div class="form-row">
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-config-oracle-server-tabs"></ul>
    </div>
    <div id="node-config-oracle-server-tabs-content" style="min-height: 170px;">
        <div id="oracle-server-tab-connection" style="display:none">
            <div class="form-row">
                <label for="node-config-input-connectionname" style="width: 150px;"><i class="fa fa-cloud"></i> Connection Name</label>
                <input class="input-append-left" type="text" required="required" id="node-config-input-connectionname" placeholder="Name">
            </div>
            <div class="form-row">
                <label for="node-config-input-connectiontype" style="width: 150px;"><i class="fa fa-question"></i> Connection Type</label>
                <select class="input-append-left" id="node-config-input-connectiontype">
                    <option value="Classic">Classic</option>
                    <option value="TNS Name">TNS Name</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-instantclientpath" style="width: 150px;"><i class="fa fa-folder"></i> Instant Client Path</label>
                <input class="input-append-left" type="text" id="node-config-input-instantclientpath" placeholder="/path/to/instantclient">
            </div>
            <div id="wallet-container" class="connection-type">
                <div class="form-row">
                    <label for="node-config-input-tnsname" style="width: 150px;"><i class="fa fa-pencil"></i> TNS Name</label>
                    <input class="input-append-left" type="text" id="node-config-input-tnsname" placeholder="tns_name">
                </div>
            </div>
            <div id="classic-container" class="connection-type">
                <div class="form-row">
                    <label for="node-config-input-host" style="width: 150px;"><i class="fa fa-globe"></i> Server</label>
                    <input class="input-append-left" type="text" id="node-config-input-host" placeholder="localhost" style="width: 40%">
                    <label for="node-config-input-port" style="margin-left: 10px; width: 35px;"> Port</label>
                    <input type="text" id="node-config-input-port" placeholder="1521" style="width:45px">
                </div>
                <div class="form-row">
                    <label for="node-config-input-db" style="width: 150px;"><i class="fa fa-home"></i> Database</label>
                    <input type="text" id="node-config-input-db" placeholder="Database name">
                </div>
            </div>
            <hr/>
            <h4>Connection Pool (Recommended)</h4>
            <div class="form-row">
                <label for="node-config-input-poolmin" style="width: 150px;"><i class="fa fa-minus-square-o"></i> Min Connections</label>
                <input type="number" id="node-config-input-poolmin" placeholder="0" style="width: 60px;">
            </div>
            <div class="form-row">
                <label for="node-config-input-poolmax" style="width: 150px;"><i class="fa fa-plus-square-o"></i> Max Connections</label>
                <input type="number" id="node-config-input-poolmax" placeholder="4" style="width: 60px;">
            </div>
            <div class="form-row">
                <label for="node-config-input-pooltimeout" style="width: 150px;"><i class="fa fa-clock-o"></i> Idle Timeout (s)</label>
                <input type="number" id="node-config-input-pooltimeout" placeholder="60" style="width: 60px;">
            </div>
        </div>
        <div id="oracle-server-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-config-input-user"><i class="fa fa-user"></i> User</label>
                <input type="text" id="node-config-input-user" >
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
                <input type="password" id="node-config-input-password" >
            </div>
        </div>
    </div>
</script>
<script type="text/x-red" data-help-name="oracle-server">
    <p>Configures the connection to your Oracle Database. Using a connection pool is highly recommended for stability.</p>
    
    <h3>Connection Properties</h3>
    <dl class="message-properties">
        <dt>Connection Name</dt>
        <dd>A unique name for this connection configuration.</dd>
        
        <dt>Connection Type</dt>
        <dd>
            <ul>
                <li><b>Classic:</b> A connection using host, port, and database name/service.</li>
                <li><b>TNS Name:</b> A connection using a TNS Name from a `tnsnames.ora` file.</li>
            </ul>
        </dd>
        
        <dt>Instant Client Path</dt>
        <dd>The path on your server to the directory in which you installed the Oracle Instant Client. Ex: <code>/path/to/instantclient</code>. This is required for the node to find the necessary Oracle libraries.</dd>
    </dl>
    
    <h3>Connection Pool</h3>
    <p>These settings control the pool of database connections managed by the driver. This is the recommended way to handle connections as it automatically recovers from network disconnects and timeouts caused by firewalls.</p>
    <dl class="message-properties">
        <dt>Min Connections</dt>
        <dd>The number of connections to create when the pool is started. Defaults to <code>0</code>.</dd>
        
        <dt>Max Connections</dt>
        <dd>The maximum number of connections the pool can have. Defaults to <code>4</code>.</dd>
        
        <dt>Idle Timeout (s)</dt>
        <dd>How long (in seconds) a connection can be idle in the pool before it is terminated to save resources. Defaults to <code>60</code>.</dd>
    </dl>
</script>
<!-- OracleDB ----------------------------------------------------------------->

<script type="text/x-red" data-template-name="oracledb">
    <div class="form-row">
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-input-oracle-out-tabs"></ul>
    </div>
    <div id="node-input-oracle-out-tabs-content" style="min-height: 170px;">
        <div id="oracle-out-tab-connection" style="display:none">
              <div class="form-row">
                  <label for="node-input-server"><i class="fa fa-globe"></i> Server</label>
                  <input type="text" id="node-input-server" type="oracle-server">
              </div>

              <br/>
              <div class="form-row">
                  <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
                  <input type="text" id="node-input-name" placeholder="Name">
              </div>
        </div>
        <div id="oracle-out-tab-query" style="display:none">
            <div class="form-row" style="margin-bottom: 0px">
                <input type="checkbox" id="node-input-usequery" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-usequery" style="width: 80%;">always execute this Oracle SQL statement (even if <i>msg.query</i> exists):</label>
            </div>

            <div class="form-row node-input-query-text-editor-row">
                <textarea id="node-input-query" style="display: none;"></textarea>
                <div style="height: 250px;" class="node-text-editor" id="node-input-query-editor" ></div>
            </div>
        </div>
        <div id="oracle-out-tab-mappings" style="display:none">
            <div class="form-row" style="margin-bottom: 0px">
                <input type="checkbox" id="node-input-usemappings" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-usemappings" style="width: 80%;"> always use field mappings (even if <i>msg.payload</i> is an array)</label>
            </div>

            <div class="form-row node-input-mappings-text-editor-row">
                <textarea id="node-input-mappings" style="display: none;"></textarea>
                <div style="height: 250px;" class="node-text-editor" id="node-input-mappings-editor" ></div>
            </div>
        </div>
        <div id="oracle-out-tab-results" style="display:none">
            <div class="form-row">
                <label for="node-input-resultaction"><i class="fa fa-hand-o-right"></i> Action</label>
                <select type="text" id="node-input-resultaction" style="width: 270px;">
                    <option value="none">ignore query results</option>
                    <option value="single">send single query result message</option>
                    <option value="single-meta">send single message with metadata</option>
                    <option value="multi">send multiple query result messages</option>
                </select>
            </div>

            <div class="form-row">
                <label for="node-input-resultlimit"><i class="fa fa-bars"></i> Msg rows</label>
                <input type="text" id="node-input-resultlimit" style="width: 80px;"> (maximum # of result rows per message)
            </div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="oracledb">
  <p>Oracle database node. Executes SQL queries, PL/SQL blocks, and stored procedures.</p>
  
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">array | object</span></dt>
    <dd>
        If an array, the values are used as positional bind parameters for the query (e.g., <code>:1, :2</code>).
        If an object, it can be used with <b>Field Mappings</b> to generate the parameter array.
    </dd>
    <dt class="optional">query <span class="property-type">string</span></dt>
    <dd>An SQL query or PL/SQL block to execute. If not provided, the query configured in the node's editor will be used.</dd>
    <dt class="optional">bindVars <span class="property-type">object</span></dt>
    <dd>
        For advanced use cases like stored procedures with <code>OUT</code> parameters. This object provides explicit bind definitions.
        <pre>msg.bindVars = {
    output: { dir: "BIND_OUT", type: "STRING" },
    input:  { dir: "BIND_IN", val: "my_value" }
};</pre>
    </dd>
    <dt class="optional">fieldMappings <span class="property-type">array</span></dt>
    <dd>An array of strings used to map properties from an object in <code>msg.payload</code> to a positional array for binding.</dd>
  </dl>

  <h3>Outputs</h3>
  <p>The output depends on the <b>Action</b> selected in the "Query results" tab.</p>
  <dl class="message-properties">
      <dt>ignore query results</dt>
      <dd>No message is sent.</dd>
      <dt>send single query result message</dt>
      <dd>Sends <b>one message</b>. <code>msg.payload</code> will be an array containing <b>all rows</b> returned by the query.</dd>
      <dt>send single message with metadata</dt>
      <dd>Sends <b>one message</b>. <code>msg.payload</code> will be an object containing metadata like <code>rowsAffected</code> and any <code>outBinds</code> from a stored procedure. This is useful for DML (INSERT, UPDATE, DELETE) or procedure calls.</dd>
      <dt>send multiple query result messages</dt>
      <dd>
          Used for processing very large result sets without high memory usage. It sends <b>multiple messages</b>, each containing a chunk of rows. The size of the chunk is determined by the <b>Msg rows</b> setting.
          <br/><br/>
          <b>Note:</b> If the total number of rows is less than the "Msg rows" limit, this option will behave identically to "send single query result message".
      </dd>
  </dl>
  
  <h3>Executing Scripts</h3>
  <p>
      The node executes a single SQL statement or a single PL/SQL block at a time. To run multiple DML statements (<code>INSERT</code>, <code>UPDATE</code>, etc.) as a single transaction, wrap them in a <code>BEGIN...END;</code> block. To run multiple sequential queries, chain multiple <b>oracledb</b> nodes together in your flow.
  </p>
</script>
<script type="text/javascript">
//
// -- oracle server --------------------------------------------------------------------------------
//
RED.nodes.registerType("oracle-server", {
    category: "config",
    defaults: {
        connectionname: { value: "", required: true },
        tnsname: { value: "" },
        connectiontype: { value: "Classic" },
        instantclientpath: { value: "" },
        host: { value: "localhost", required: false },
        port: { value: 1521, required: false, validate: RED.validators.number() },
        db: { value: "", required: false },
        poolmin: { value: 0, required: false, validate: RED.validators.number() },
        poolmax: { value: 4, required: false, validate: RED.validators.number() },
        pooltimeout: { value: 60, required: false, validate: RED.validators.number() },
    },
    credentials: {
        user: { type: "text" },
        password: { type: "password" }
    },
    label: function () {
        return this.connectionname;
    },
    oneditprepare: function () {
        var tabs = RED.tabs.create({
            id: "node-config-oracle-server-tabs",
            onchange: function (tab) {
                $("#node-config-oracle-server-tabs-content").children().hide();
                $("#" + tab.id).show();
            }
        });
        $(".connection-type").hide();
        $("#node-config-input-connectiontype").on("change", function (evt) {
            var ct = evt.currentTarget;
            if (ct.value === "TNS Name") {
                $("#wallet-container").show();
                $("#classic-container").hide();
                $("#node-config-input-host").val("");
                $("#node-config-input-port").val("");
                $("#node-config-input-db").val("");
            }
            else {
                $("#wallet-container").hide();
                $("#classic-container").show();
                $("#node-config-input-tnsname").val("");
            }
        }).trigger("change");
        tabs.addTab({
            id: "oracle-server-tab-connection",
            label: "Connection"
        });
        tabs.addTab({
            id: "oracle-server-tab-security",
            label: "Security"
        });
        setTimeout(function () { tabs.resize(); }, 0);
    }
});

//
// -- oracledb -------------------------------------------------------------------------------------
//
RED.nodes.registerType("oracledb", {
    category: "storage",
    defaults: {
        name: { value: "" },
        usequery: { value: false },
        query: { value: "INSERT INTO oracleTableName" +
                "\n\t(fieldName1, fieldName2, Fieldname3)" +
                "\n\tVALUES (" +
                "\n\t\t:valueOfValuesArrayIndex0," +
                "\n\t\t:valueOfValuesArrayIndex1," +
                "\n\t\t:valueOfValuesArrayIndex2," +
                "\n\t)" },
        usemappings: { value: false },
        mappings: { value: "[" +
                "\n\t\"location.of.first.array.index.field.in.msg.payload\"," +
                "\n\t\"location.of.second.array.index.field\"," +
                "\n\t\"last_array_indexfield.in[3]\"" +
                "\n]" },
        server: { type: "oracle-server", required: true },
        resultaction: { value: "multi" },
        resultlimit: { value: 100 }
    },
    inputs: 1,
    outputs: 1,
    color: "#ff6666",
    icon: "db.png",
    align: "right",
    label: function () {
        return this.name || "oracledb";
    },
    labelStyle: function () {
        return this.name ? "node_label_italic" : "";
    },
    oneditprepare: function () {
        // use query editor
        var queryField = $("#node-input-query");
        var queryEditor = RED.editor.createEditor({
            id: "node-input-query-editor",
            mode: "ace/mode/sql", // unfortunately not yet included in the node-red version of ace
            value: queryField.val()
        });
        queryEditor.getSession().on("change", function () {
            queryField.val(queryEditor.getSession().getValue());
        });
        // use mappings editor
        var mappingsField = $("#node-input-mappings");
        var mappingsEditor = RED.editor.createEditor({
            id: "node-input-mappings-editor",
            mode: "ace/mode/json",
            value: mappingsField.val()
        });
        mappingsEditor.getSession().on("change", function () {
            mappingsField.val(mappingsEditor.getSession().getValue());
        });
        var visibleTab = "query";
        var tabs = RED.tabs.create({
            id: "node-input-oracle-out-tabs",
            onchange: function (tab) {
                $("#node-input-oracle-out-tabs-content").children().hide();
                $("#" + tab.id).show();
                if (tab.id === "oracle-out-tab-query") {
                    visibleTab = "query";
                    functionDialogResize();
                    queryEditor.focus();
                }
                if (tab.id === "oracle-out-tab-mappings") {
                    visibleTab = "mappings";
                    functionDialogResize();
                    mappingsEditor.focus();
                }
            }
        });
        tabs.addTab({
            id: "oracle-out-tab-connection",
            label: "Server connection"
        });
        tabs.addTab({
            id: "oracle-out-tab-query",
            label: "SQL query"
        });
        tabs.addTab({
            id: "oracle-out-tab-mappings",
            label: "Field mappings"
        });
        tabs.addTab({
            id: "oracle-out-tab-results",
            label: "Query results"
        });
        setTimeout(function () { tabs.resize(); }, 0);
        // resize editor areas to fit the edit window
        var functionDialogResize = function () {
            var height = $("#dialog-form").height();
            height -= $("#node-input-oracle-out-tabs").outerHeight(true);
            var rows = $("#oracle-out-tab-" + visibleTab + ">div:not(.node-input-" + visibleTab + "-text-editor-row)");
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-" + visibleTab + "-text-editor-row");
            if (editorRow.css("marginTop")) {
                height -= parseInt(editorRow.css("marginTop"), 10);
            }
            if (editorRow.css("marginBottom")) {
                height -= parseInt(editorRow.css("marginBottom"), 10);
            }
            height -= 5;
            $("#node-input-" + visibleTab + "-editor").css("height", height + "px");
            if (visibleTab === "query") {
                queryEditor.resize();
            }
            else {
                mappingsEditor.resize();
            }
        };
        var d = $("#dialog");
        d.on("dialogresize", functionDialogResize);
        d.one("dialogopen", function () {
            var size = d.dialog("option", "sizeCache-function");
            if (size) {
                d.dialog("option", "width", size.width);
                d.dialog("option", "height", size.height);
                functionDialogResize();
            }
        });
        d.one("dialogclose", function () {
            d.off("dialogresize", functionDialogResize);
        });
    }
});

</script>